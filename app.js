let provider;
let signer;

// Updated ABI (payable constructor)
const tokenABI = [ /* ... same as before ... */ ];

// Full bytecode from Remix
const tokenBytecode = "6080604052600660025f6101000a81548160ff021916908360ff16021790555060405161126f38038061126f833981810160405281019061004091906103dd565b66038d7ea4c680003414610089576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610080906104e5565b60405180910390fd5b825f9081610097919061070a565b5081600190816100a7919061070a565b5060025f9054906101000a900460ff1660ff16600a6100c69190610935565b816100d1919061097f565b600381905550735def5bd962988d32d85eeae3496dc12dc2eeb31f60055f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505f606460035461013b91906109ed565b90508060045f60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550806003546101ae9190610a1d565b60045f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f208190555060055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3490811502906040515f60405180830381858888f19350505050158015610253573d5f5f3e3d5ffd5b5050505050610a50565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6102bc82610276565b810181811067ffffffffffffffff821117156102db576102da610286565b5b80604052505050565b5f6102ed61025d565b90506102f982826102b3565b919050565b5f67ffffffffffffffff82111561031857610317610286565b5b61032182610276565b9050602081019050919050565b8281835e5f83830152505050565b5f61034e610349846102fe565b6102e4565b90508281526020810184848401111561036a57610369610272565b5b61037584828561032e565b509392505050565b5f82601f8301126103915761039061026e565b5b81516103a184826020860161033c565b91505092915050565b5f819050919050565b6103bc816103aa565b81146103c6575f5ffd5b50565b5f815190506103d7816103b3565b92915050565b5f5f5f606084860312156103f4576103f3610266565b5b5f84015167ffffffffffffffff8111156104115761041061026a565b5b61041d8682870161037d565b935050602084015167ffffffffffffffff81111561043e5761043d61026a565b5b61044a8682870161037d565b925050604061045b868287016103c9565b9150509250925092565b5f82825260208201905092915050565b7f4d7573742070617920302e30303120414254206465706c6f796d656e742066655f8201527f6500000000000000000000000000000000000000000000000000000000000000602082015250565b5f6104cf602183610465565b91506104da82610475565b604082019050919050565b5f6020820190508181035f8301526104fc816104c3565b9050919050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061055157607f821691505b6020821081036105645761056361050d565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026105c67fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261058b565b6105d0868361058b565b95508019841693508086168417925050509392505050565b5f819050919050565b5f61060b610606610601846103aa565b6105e8565b6103aa565b9050919050565b5f819050919050565b610624836105f1565b61063861063082610612565b848454610597565b825550505050565b5f5f905090565b61064f610640565b61065a81848461061b565b505050565b5b8181101561067d576106725f82610647565b600181019050610660565b5050565b601f8211156106c2576106938161056a565b61069c8461057c565b810160208510156106ab578190505b6106bf6106b78561057c565b83018261065f565b50505b505050565b5f82821c905092915050565b5f6106e25f19846008026106c7565b1980831691505092915050565b5f6106fa83836106d3565b9150826002028217905092915050565b61071382610503565b67ffffffffffffffff81111561072c5761072b610286565b5b610736825461053a565b610741828285610681565b5f60209050601f831160018114610772575f8415610760578287015190505b61076a85826106ef565b8655506107d1565b601f1984166107808661056a565b5f5b828110156107a757848901518255600182019150602085019450602081019050610782565b868310156107c457848901516107c0601f8916826106d3565b8355505b6001600288020188555050505b505050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f8160011c9050919050565b5f5f8291508390505b600185111561085b57808604811115610837576108366107d9565b5b60018516156108465780820291505b808102905061085485610806565b945061081b565b94509492505050565b5f82610873576001905061092e565b81610880575f905061092e565b816001811461089657600281146108a0576108cf565b600191505061092e565b60ff8411156108b2576108b16107d9565b5b8360020a9150848211156108c9576108c86107d9565b5b5061092e565b5060208310610133831016604e8410600b84101617156109045782820a9050838111156108ff576108fe6107d9565b5b61092e565b6109118484846001610812565b92509050818404811115610928576109276107d9565b5b81810290505b9392505050565b5f61093f826103aa565b915061094a836103aa565b92506109777fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484610864565b905092915050565b5f610989826103aa565b9150610994836103aa565b92508282026109a2816103aa565b915082820484148315176109b9576109b86107d9565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f6109f7826103aa565b9150610a02836103aa565b925082610a1257610a116109c0565b5b828204905092915050565b5f610a27826103aa565b9150610a32836103aa565b9250828203905081811115610a4a57610a496107d9565b5b92915050565b61081280610a5d5f395ff3fe608060405234801561000f575f5ffd5b5060043610610086575f3560e01c806370a082311161005957806370a08231146101025780638da5cb5b1461013257806395d89b4114610150578063a9059cbb1461016e57610086565b806306fdde031461008a57806318160ddd146100a8578063313ce567146100c65780634f23daf3146100e4575b5f5ffd5b61009261019e565b60405161009f91906104b3565b60405180910390f35b6100b0610229565b6040516100bd91906104eb565b60405180910390f35b6100ce61022f565b6040516100db919061051f565b60405180910390f35b6100ec610241565b6040516100f991906104eb565b60405180910390f35b61011c60048036038101906101179190610596565b61024c565b60405161012991906104eb565b60405180910390f35b61013a610261565b60405161014791906105d0565b60405180910390f35b610158610286565b60405161016591906104b3565b60405180910390f35b61018860048036038101906101839190610613565b610312565b604051610195919061066b565b60405180910390f35b5f80546101aa906106b1565b80601f01602080910402602001604051908101604052809291908181526020018280546101d6906106b1565b80156102215780601f106101f857610100808354040283529160200191610221565b820191905f5260205f20905b81548152906001019060200180831161020457829003601f168201915b505050505081565b60035481565b60025f9054906101000a900460ff1681565b66038d7ea4c6800081565b6004602052805f5260405f205f915090505481565b60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60018054610293906106b1565b80601f01602080910402602001604051908101604052809291908181526020018280546102bf906106b1565b801561030a5780601f106102e15761010080835404028352916020019161030a565b820191905f5260205f20905b8154815290600101906020018083116102ed57829003601f168201915b505050505081565b5f8160045f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20541015610393576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161038a9061072b565b60405180910390fd5b8160045f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546103df9190610776565b925050819055508160045f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825461043291906107a9565b925050819055506001905092915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f61048582610443565b61048f818561044d565b935061049f81856020860161045d565b6104a88161046b565b840191505092915050565b5f6020820190508181035f8301526104cb818461047b565b905092915050565b5f819050919050565b6104e5816104d3565b82525050565b5f6020820190506104fe5f8301846104dc565b92915050565b5f60ff82169050919050565b61051981610504565b82525050565b5f6020820190506105325f830184610510565b92915050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6105658261053c565b9050919050565b6105758161055b565b811461057f575f5ffd5b50565b5f813590506105908161056c565b92915050565b5f602082840312156105ab576105aa610538565b5b5f6105b884828501610582565b91505092915050565b6105ca8161055b565b82525050565b5f6020820190506105e35f8301846105c1565b92915050565b6105f2816104d3565b81146105fc575f5ffd5b50565b5f8135905061060d816105e9565b92915050565b5f5f6040838503121561062957610628610538565b5b5f61063685828601610582565b9250506020610647858286016105ff565b9150509250929050565b5f8115159050919050565b61066581610651565b82525050565b5f60208201905061067e5f83018461065c565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806106c857607f821691505b6020821081036106db576106da610684565b5b50919050565b7f496e73756666696369656e742062616c616e63650000000000000000000000005f82015250565b5f61071560148361044d565b9150610720826106e1565b602082019050919050565b5f6020820190508181035f83015261074281610709565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610780826104d3565b915061078b836104d3565b92508282039050818111156107a3576107a2610749565b5b92915050565b5f6107b3826104d3565b91506107be836104d3565b92508282019050808211156107d6576107d5610749565b5b9291505056fea2646970667358221220e3bba978300180bf44d0c816d081ea23e320d10065166938e7bb354046a8854164736f6c634300081e0033";

// Switch to Abstract network
async function switchToAbstract() {
  const ethereum = window.ethereum;
  if (!ethereum) throw new Error("MetaMask not detected");

  const abstractChainId = "0xab5";
  const currentChainId = await ethereum.request({ method: "eth_chainId" });

  if (currentChainId !== abstractChainId) {
    await ethereum.request({
      method: "wallet_addEthereumChain",
      params: [{
        chainId: abstractChainId,
        chainName: "Abstract",
        rpcUrls: ["https://api.mainnet.abs.xyz"],
        nativeCurrency: { name: "ABT", symbol: "ABT", decimals: 18 },
        blockExplorerUrls: ["https://explorer.abstract.network"]
      }]
    });
    await ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: abstractChainId }] });
  }
}

// Deploy Token
document.getElementById("deployForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const status = document.getElementById("status");
  status.textContent = "⏳ Connecting to wallet...";

  try {
    const ethereum = window.ethereum;
    if (!ethereum) {
      status.textContent = "❌ Please install MetaMask or Abstract-compatible wallet.";
      return;
    }

    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    provider = new ethers.BrowserProvider(ethereum);
    signer = await provider.getSigner(accounts[0]);

    status.textContent = "🌐 Switching to Abstract network...";
    await switchToAbstract();

    const name = document.getElementById("tokenName").value;
    const symbol = document.getElementById("tokenSymbol").value;
    const supply = document.getElementById("totalSupply").value;

    const factory = new ethers.ContractFactory(tokenABI, tokenBytecode, signer);
    const deployFee = ethers.parseUnits("0.001", 18); // 0.001 ABT

    status.textContent = `🚀 Deploying token... (Fee: 0.001 ABT + 1% to owner)`;
    const contract = await factory.deploy(name, symbol, supply, { value: deployFee });

    status.textContent = "⏳ Waiting for deployment confirmation...";
    await contract.waitForDeployment();

    const address = await contract.getAddress();
    status.textContent =
      `✅ Token deployed!\nAddress: ${address}\nName: ${name}\nSymbol: ${symbol}\nTotal Supply: ${supply}\n💸 0.001 ABT fee sent to owner\n🏷️ Owner gets 1% of supply.`;
  } catch (err) {
    console.error(err);
    status.textContent = `❌ Error: ${err.message}`;
  }
});
